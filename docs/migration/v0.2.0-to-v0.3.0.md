# Migration Guide: v0.2.0 â†’ v0.3.0

## Overview

This guide helps you migrate from Appiman v0.2.0 to v0.3.0. v0.3.0 is a major release that removes all shell script dependencies and implements functionality in pure Rust.

## Breaking Changes

### 1. Systemd Units Now Call Binary Directly

**v0.2.0:**
```ini
[Service]
Type=oneshot
ExecStart=/usr/local/sbin/register-appimages.sh
```

**v0.3.0:**
```ini
[Service]
Type=oneshot
ExecStart=/usr/local/bin/appiman scan
```

**Impact:** systemd units installed by `appiman init` will automatically use the new format.

### 2. Shell Scripts Removed

**Removed Files:**
- `/usr/local/sbin/move-appimages.sh`
- `/usr/local/sbin/register-appimages.sh`

**Impact:** These files are no longer installed or used.

### 3. New Configuration System

**v0.2.0:**
- Hardcoded directory paths
- No configuration file support

**v0.3.0:**
- TOML configuration file at `/etc/appiman/config.toml`
- Environment variable overrides
- All paths configurable

### 4. Structured Logging

**v0.2.0:**
```rust
println!("Processing AppImage: {}", name);
eprintln!("Error: {}", error);
```

**v0.3.0:**
```rust
use tracing::{info, error};

info!("Processing AppImage: {}", name);
error!("Failed to process: {}", error);
```

**Impact:** Logs are now structured and configurable via `RUST_LOG`.

## Migration Steps

### Step 1: Backup Current Configuration (Optional)

If you have modified systemd units or shell scripts:

```bash
# Backup custom systemd units
sudo cp /etc/systemd/system/*.service /tmp/
sudo cp /etc/systemd/system/*.path /tmp/

# Backup shell scripts (if customized)
sudo cp /usr/local/sbin/*.sh /tmp/
```

### Step 2: Upgrade Appiman Binary

```bash
# Remove old binary
sudo rm /usr/local/bin/appiman

# Install new binary (AppImage)
wget https://github.com/derungo/appiman/releases/download/v0.3.0/appiman-0.3.0-x86_64.AppImage
chmod +x appiman-0.3.0-x86_64.AppImage
sudo ./appiman-0.3.0-x86_64.AppImage install

# Or build from source
cargo build --release
sudo install -Dm755 target/release/appiman /usr/local/bin/appiman
```

### Step 3: Reinitialize System

```bash
# Disable old services
sudo appiman disable

# Initialize with new systemd units
sudo appiman init

# Re-enable services
sudo appiman enable
```

**What `appiman init` does:**
- Creates `/opt/applications/{raw,bin,icons}` directories
- Installs systemd units that call `appiman scan` and `appiman ingest`
- No longer installs shell scripts

### Step 4: Update Configuration (Optional)

If you want to customize paths:

```bash
# Create config directory
sudo mkdir -p /etc/appiman

# Create default config
sudo cat > /etc/appiman/config.toml <<EOF
[directories]
raw = "/opt/applications/raw"
bin = "/opt/applications/bin"
icons = "/opt/applications/icons"
desktop = "/usr/share/applications"
symlink = "/usr/local/bin"
home_root = "/home"

[logging]
level = "info"
json_output = false
EOF
```

Or use environment variables:

```bash
export APPIMAN_RAW_DIR="/opt/applications/raw"
export APPIMAN_BIN_DIR="/opt/applications/bin"
export APPIMAN_LOG_LEVEL="debug"
```

### Step 5: Test Migration

```bash
# Run a manual scan to ensure everything works
sudo appiman scan

# Check status
sudo appiman status

# Verify systemd services
systemctl status move-appimages.path
systemctl status register-appimages.path
```

## Testing Checklist

- [ ] `appiman init` completes without errors
- [ ] `appiman enable` starts systemd path watchers
- [ ] `appiman status` shows systemd units as enabled/active
- [ ] Downloaded AppImages are automatically ingested and registered
- [ ] Application launcher shows AppImages with icons
- [ ] CLI commands work: `appiman ingest`, `appiman scan`, `appiman sync`, `appiman clean`
- [ ] No shell scripts in `/usr/local/sbin/` (should be empty/deleted)
- [ ] Systemd units call `appiman` binary directly

## Rollback Procedure

If you encounter issues with v0.3.0:

### Option 1: Reinstall v0.2.0

```bash
# Stop v0.3.0 services
sudo appiman disable

# Remove v0.3.0 binary
sudo rm /usr/local/bin/appiman

# Download and install v0.2.0
wget https://github.com/derungo/appiman/releases/download/v0.2.0/appiman-0.2.0-x86_64.AppImage
chmod +x appiman-0.2.0-x86_64.AppImage
sudo ./appiman-0.2.0-x86_64.AppImage init

# Restore v0.2.0 systemd units (if backed up)
sudo cp /tmp/*.service /etc/systemd/system/
sudo cp /tmp/*.path /etc/systemd/system/
sudo cp /tmp/*.sh /usr/local/sbin/
sudo chmod +x /usr/local/sbin/*.sh

# Reload systemd
sudo systemctl daemon-reload
sudo appiman enable
```

### Option 2: Report Issues

If you encounter bugs, please report them:
1. Check GitHub Issues: https://github.com/derungo/appiman/issues
2. Include:
   - Appiman version: `appiman --version`
   - Linux distribution: `cat /etc/os-release`
   - Error messages
   - Steps to reproduce

## Data Migration

### AppImages and Icons

**No Action Required**

Your existing AppImages and icons in `/opt/applications/` are compatible with v0.3.0. The new Rust implementation processes the same files in the same way.

### Desktop Entries

**No Action Required**

Existing `.desktop` files in `/usr/share/applications/` will continue to work. New registrations will use the updated format.

### Symlinks

**No Action Required**

Symlinks in `/usr/local/bin/` are compatible with both versions.

## New Features

Take advantage of new v0.3.0 features:

### JSON Output for Status

```bash
sudo appiman status --json
```

Useful for:
- Automation scripts
- Monitoring dashboards
- Programmatic access to AppImage inventory

### Enhanced Status Reporting

```bash
sudo appiman status
```

Now includes:
- Registered AppImages with version info
- Storage usage breakdown
- Last scan timestamp
- Failed registration errors

### Flexible Logging

```bash
# Debug logging
RUST_LOG=debug sudo appiman scan

# JSON logging for aggregation
RUST_LOG=info,appiman=debug sudo appiman scan
```

### Configuration System

```toml
[directories]
# Customize any path
raw = "/opt/applications/raw"
bin = "/opt/applications/bin"

[logging]
# Set log level
level = "info"
# Use JSON output
json_output = false
```

## Troubleshooting

### Systemd Services Won't Start

**Symptom:**
```bash
sudo systemctl status move-appimages.service
# Shows "not found"
```

**Solution:**
```bash
# Reinitialize to install updated units
sudo appiman init
sudo systemctl daemon-reload
sudo appiman enable
```

### AppImages Not Auto-Registering

**Symptom:** Downloaded AppImages stay in Downloads folder

**Diagnosis:**
```bash
# Check if path watcher is active
sudo appiman status

# Check systemd path watcher
systemctl status move-appimages.path
```

**Solution:**
```bash
# Ensure path watcher is enabled
sudo appiman enable

# Manually trigger ingestion
sudo appiman sync
```

### Icons Not Showing

**Symptom:** AppImages appear in launcher without icons

**Diagnosis:**
```bash
# Check if icons exist
ls -la /opt/applications/icons/

# Check desktop entry icon path
grep Icon /usr/share/applications/*.desktop
```

**Solution:**
```bash
# Re-scan to extract icons
sudo appiman scan

# Check if icon extraction succeeded
sudo appiman status
```

### Permission Denied Errors

**Symptom:** `Permission denied` when running `appiman ingest`

**Solution:**
```bash
# All appiman commands require root
sudo appiman ingest
```

## Support

If you need help after migration:

- **Documentation:** https://github.com/derungo/appiman
- **Issues:** https://github.com/derungo/appiman/issues
- **Discussions:** https://github.com/derungo/appiman/discussions

---

*Last Updated: January 3, 2026*
*Version: 0.3.0*
