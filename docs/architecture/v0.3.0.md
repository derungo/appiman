# Appiman v0.3.0 Architecture

## Overview

Appiman v0.3.0 represents a complete rewrite of the shell-script based v0.2.0, implementing all functionality in pure Rust with improved error handling, structured logging, and comprehensive testing.

## Design Principles

1. **Pure Rust Implementation** - No external script dependencies
2. **Structured Error Handling** - Using `thiserror` for clear error messages
3. **Comprehensive Testing** - Unit, integration, and property-based tests
4. **Configuration Flexibility** - TOML config files with environment variable overrides
5. **Structured Logging** - `tracing` for production-ready observability

## Module Architecture

```
src/
├── core/                    # Core data structures and utilities
│   ├── appimage.rs          # AppImage struct, validation
│   ├── metadata.rs          # Metadata extraction and serialization
│   ├── normalization.rs     # Name normalization logic
│   └── mod.rs
│
├── mover/                   # AppImage ingestion
│   ├── scanner.rs           # File system scanning
│   ├── mover.rs            # File moving with collision handling
│   ├── conflict.rs         # Collision resolution
│   └── mod.rs
│
├── registrar/               # AppImage registration
│   ├── processor.rs        # Main processing pipeline
│   ├── icon_extractor.rs   # Icon extraction from AppImages
│   ├── desktop_entry.rs   # .desktop file generation
│   ├── symlink.rs          # Symlink management
│   └── mod.rs
│
├── config.rs                # Configuration management
├── logger.rs              # Logging setup
├── clean.rs               # Cleanup operations
├── ingest.rs              # Ingestion command
├── scan.rs               # Scan command
├── sync.rs               # Sync command
├── status.rs             # Status reporting
├── setup.rs             # System initialization
├── systemd.rs           # Systemd unit management
├── privileges.rs        # Privilege checking
├── log.rs              # Log viewing
└── main.rs             # CLI entry point
```

## Core Components

### Core Module (`src/core/`)

#### `AppImage` (`appimage.rs`)

Represents an AppImage file with validation and metadata extraction capabilities.

```rust
pub struct AppImage {
    pub path: PathBuf,
    pub metadata: Option<Metadata>,
}

impl AppImage {
    pub fn new(path: PathBuf) -> Result<Self, AppImageError>;
    pub fn validate(&self) -> Result<(), ValidationError>;
    pub fn get_checksum(&self) -> Result<String, IoError>;
}
```

**Key Features:**
- Validates that files are executable and have .AppImage extension
- Extracts metadata from embedded .desktop files
- Computes SHA256 checksums for integrity verification

#### `Metadata` (`metadata.rs`)

Holds extracted metadata from AppImage .desktop entries.

```rust
pub struct Metadata {
    pub name: String,
    pub categories: Vec<String>,
    pub icon_path: Option<PathBuf>,
    pub checksum: String,
}
```

**Key Features:**
- Parses freedesktop.org .desktop entry format
- Supports optional fields (Icon, Categories)
- JSON serialization for persistence

#### Name Normalization (`normalization.rs`)

Normalizes AppImage filenames to canonical, version-agnostic names.

```rust
pub fn normalize_appimage_name(name: &str) -> String
```

**Transformations (in order):**
1. Remove architecture markers: x86_64, amd64, i386, linux, setup
2. Remove version patterns: -v1.2.3, -1.0.0, v2
3. Normalize separators (-, _, .) to single hyphen
4. Remove leading/trailing hyphens
5. Convert to lowercase

**Examples:**
- `MyApp-v1.2.3-x86_64.AppImage` → `myapp`
- `FirefoxSetup-128.AppImage` → `firefox`
- `LibreOffice-7.6.AppImage` → `libreoffice`

### Mover Module (`src/mover/`)

Handles discovery and movement of user-downloaded AppImages to staging.

#### `Scanner` (`scanner.rs`)

Recursively scans user home directories for AppImages.

```rust
pub struct Scanner {
    pub home_root: PathBuf,
    pub exclude_dirs: Vec<PathBuf>,
}

impl Scanner {
    pub fn find_appimages(&self) -> Result<Vec<PathBuf>, ScanError>;
    pub fn find_user_dirs(&self) -> Result<Vec<PathBuf>, IoError>;
}
```

**Key Features:**
- Recursive file system scanning using `walkdir`
- Case-insensitive .AppImage extension matching
- Configurable exclude directories
- Permission-aware error handling

#### `Mover` (`mover.rs`)

Moves AppImages to staging directory with collision resolution.

```rust
pub struct Mover {
    pub source_dir: PathBuf,
    pub dest_dir: PathBuf,
}

impl Mover {
    pub fn move_appimages(&self, paths: &[PathBuf]) -> Result<MoveReport, MoveError>;
}

pub struct MoveReport {
    pub moved: Vec<PathBuf>,
    pub skipped: Vec<PathBuf>,
    pub errors: Vec<(PathBuf, String)>,
}
```

**Key Features:**
- Atomic file moves (renames within filesystem)
- Collision handling with numeric suffixes
- Sets ownership to root:root
- Sets permissions to 0755

**Collision Example:**
```
/app-1.AppImage (first)
/app-2.AppImage (second)
/app-3.AppImage (third)
```

### Registrar Module (`src/registrar/`)

Processes AppImages and registers them system-wide.

#### `Processor` (`processor.rs`)

Main processing pipeline for AppImage registration.

```rust
pub struct Processor {
    pub raw_dir: PathBuf,
    pub bin_dir: PathBuf,
    pub icon_dir: PathBuf,
    pub desktop_dir: PathBuf,
    pub symlink_dir: PathBuf,
}

impl Processor {
    pub fn process_all(&self) -> Result<ProcessReport, ProcessError>;
    pub fn process_single_appimage(&self, app_path: &Path) -> Result<ProcessedApp, ProcessError>;
}
```

**Processing Pipeline:**

1. **Validation** - Verify file is valid AppImage
2. **Normalization** - Generate canonical name
3. **Copy** - Copy to `/opt/applications/bin/` with .AppImage suffix
4. **Make Executable** - Set 0755 permissions
5. **Extract Metadata** - Extract AppImage to temp directory
6. **Find Desktop Entry** - Parse embedded .desktop file
7. **Extract Icon** - Copy icon to `/opt/applications/icons/`
8. **Create Desktop Entry** - Write to `/usr/share/applications/`
9. **Create Symlink** - Symlink to `/usr/local/bin/`
10. **Update Check** - Run `--appimage-update` if supported

**Directory Structure:**
```
/opt/applications/
├── raw/              # Staging area (input)
├── bin/              # Processed AppImages
└── icons/            # Extracted icons

/usr/share/applications/  # Desktop entries
/usr/local/bin/         # CLI symlinks
```

#### `IconExtractor` (`icon_extractor.rs`)

Extracts icon files from extracted AppImages.

```rust
pub fn extract_icon(
    app_dir: &Path,
    icon_dir: &Path,
    normalized_name: &str,
) -> Result<Option<PathBuf>, IconExtractError>
```

**Key Features:**
- Finds PNG and SVG icons in extracted directory
- Preserves existing icons (idempotent)
- Returns None if no icon found
- Preserves original extension (.png or .svg)

#### `DesktopEntry` (`desktop_entry.rs`)

Generates freedesktop.org .desktop files.

```rust
pub struct DesktopEntry {
    pub name: String,
    pub exec: String,
    pub icon: String,
    pub categories: Vec<String>,
}

impl DesktopEntry {
    pub fn with_categories(name: String, exec: String, icon: String, categories: Vec<String>) -> Self;
    pub fn to_file_content(&self) -> String;
}
```

**Output Format:**
```ini
[Desktop Entry]
Type=Application
Name=MyApp
Exec=/opt/applications/bin/myapp.AppImage
Icon=/opt/applications/icons/myapp.png
Terminal=false
Categories=Utility;
```

#### `Symlink` (`symlink.rs`)

Creates and manages symlinks in `/usr/local/bin/`.

```rust
pub fn create_symlink(target: &Path, link_path: &Path) -> Result<(), SymlinkError>
```

**Key Features:**
- Removes existing symlinks before creation
- Creates symbolic links to AppImage binaries
- Allows CLI invocation without path

### Configuration (`src/config.rs`)

Manages configuration from TOML files and environment variables.

```rust
pub struct Config {
    pub directories: Directories,
    pub logging: LoggingConfig,
}

pub struct Directories {
    pub raw: PathBuf,
    pub bin: PathBuf,
    pub icon: PathBuf,
    pub desktop: PathBuf,
    pub symlink: PathBuf,
    pub home_root: PathBuf,
}

impl Config {
    pub fn load() -> Result<Self, ConfigError>;
}
```

**Configuration Hierarchy:**
1. Default values (hardcoded)
2. TOML file (`/etc/appiman/config.toml`)
3. Environment variables (APPIMAN_*)

**Environment Variables:**
- `APPIMAN_CONFIG` - Path to config file
- `APPIMAN_RAW_DIR` - Staging directory
- `APPIMAN_BIN_DIR` - Processed AppImages directory
- `APPIMAN_ICON_DIR` - Icon storage directory
- `APPIMAN_DESKTOP_DIR` - Desktop entries directory
- `APPIMAN_SYMLINK_DIR` - Symlink directory
- `APPIMAN_HOME_ROOT` - User home directories root

### Logging (`src/logger.rs`)

Structured logging with `tracing` crate.

```rust
pub fn init_logger() -> Result<(), LoggerError>
```

**Features:**
- Configurable log levels (trace, debug, info, warn, error)
- JSON and pretty output formats
- Environment variable configuration (`RUST_LOG`)
- Thread IDs and file/line information in debug mode

## Error Handling Strategy

All modules use `thiserror` for structured error types.

**Error Hierarchy:**
```
AppImageError
├── InvalidFormat
├── ExtractFailed
└── IoError

ProcessError
├── IoError
├── AppImageError
├── ExtractionFailed
└── DesktopEntryError

MoveError
├── IoError
└── ScanError

ConfigError
├── IoError
├── ParseError
└── ValidationError
```

**Error Message Format:**
```rust
#[error("Failed to process AppImage {path}: {reason}")]
ProcessingFailed { path: PathBuf, reason: String }
```

## Testing Strategy

### Unit Tests
- Test individual functions in isolation
- Mock file system with `tempfile::TempDir`
- Property-based tests for normalization

### Integration Tests
- Test full workflows (ingest → scan)
- Use temporary directory trees
- Test systemd integration (mocked)

### Shell Script Comparison Tests
- Run shell scripts in parallel with Rust implementation
- Compare output files
- Verify identical behavior

## Performance Considerations

### Optimizations
1. **Lazy File Operations** - Only copy if destination doesn't exist
2. **Efficient Scanning** - Use `walkdir` for fast traversal
3. **Idempotent Operations** - Safe to run multiple times
4. **Parallel Processing Ready** - Structured for future parallelization

### Benchmarks
Target performance (v0.3.0):
- **Ingest**: < 5s for 100 AppImages
- **Scan**: < 3s for 100 AppImages
- **Memory**: < 50MB baseline

## System Integration

### Systemd Units

**Path Watchers:**
- `move-appimages.path` - Monitors `/home` for AppImage downloads
- `register-appimages.path` - Monitors `/opt/applications/raw` for new files

**Services:**
- `move-appimages.service` - Runs `appiman ingest`
- `register-appimages.service` - Runs `appiman scan`

**Activation Flow:**
```
User downloads AppImage → move-appimages.path triggers
→ move-appimages.service runs appiman ingest
→ AppImage moved to /opt/applications/raw
→ register-appimages.path triggers
→ register-appimages.service runs appiman scan
→ AppImage registered system-wide
```

### Security Model

- **Root Required** - All operations require root privileges
- **Multi-User Safe** - Never touches user configs or non-AppImage files
- **Sandboxed** - AppImages run in their own namespace
- **Checksum Verification** - Planned for integrity checks

## Future Extensibility

### Version Management (v0.4.0+)
- Track multiple versions per application
- Version pinning
- Automatic cleanup of old versions

### Plugin System (v0.5.0+)
- Pre/post processing hooks
- Custom icon extractors
- Third-party integrations

### Observability (v0.5.0+)
- Prometheus metrics exporter
- Structured logging with correlation IDs
- Health check endpoint

---

*Last Updated: January 3, 2026*
*Version: 0.3.0*
